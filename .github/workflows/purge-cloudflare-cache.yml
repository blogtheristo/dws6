name: Purge Cloudflare Cache

on:
  push:
    branches:
      - main
    paths:
      - 'dws10.com/**'
      - 'onelifetime.world/**'
      - 'landing-pages/**'
      - 'images/**'
  workflow_dispatch:

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Purge Cloudflare Cache for dws10.com
        if: env.CLOUDFLARE_API_TOKEN != ''
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID_DWS10: ${{ secrets.CLOUDFLARE_ZONE_ID_DWS10 }}
        run: |
          if [ -n "$CLOUDFLARE_ZONE_ID_DWS10" ]; then
            echo "Purging Cloudflare cache for dws10.com..."
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID_DWS10}/purge_cache" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' \
              | jq '.'
          else
            echo "CLOUDFLARE_ZONE_ID_DWS10 not set, skipping dws10.com cache purge"
          fi
      
      - name: Purge Cloudflare Cache for onelifetime.world
        if: env.CLOUDFLARE_API_TOKEN != ''
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID_ONELIFETIME: ${{ secrets.CLOUDFLARE_ZONE_ID_ONELIFETIME }}
        run: |
          if [ -n "$CLOUDFLARE_ZONE_ID_ONELIFETIME" ]; then
            echo "Purging Cloudflare cache for onelifetime.world..."
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID_ONELIFETIME}/purge_cache" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' \
              | jq '.'
          else
            echo "CLOUDFLARE_ZONE_ID_ONELIFETIME not set, skipping onelifetime.world cache purge"
          fi
      
      - name: Summary
        run: |
          echo "âœ… Cloudflare cache purge completed!"
          echo "Changes should appear within 30 seconds globally."

